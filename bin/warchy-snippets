#!/usr/bin/env bash
set -euo pipefail

# Configuration
COMMANDS_FILE="$XDG_CONFIG_HOME/warchy/commands"

# Catppuccin Mocha Colors
C_PINK="#f5c2e7"
C_MAUVE="#cba6f7"
C_TEXT="#cdd6f4"
C_SURFACE1="#45475a"
C_BLUE="#89b4fa"
C_YELLOW="#f9e2af"

# Check if commands file exists
if [[ ! -f "$COMMANDS_FILE" ]]; then
  echo "Error: Commands file not found at $COMMANDS_FILE" >&2
  echo "Create it with: mkdir -p $(dirname "$COMMANDS_FILE") && touch $COMMANDS_FILE" >&2
  exit 1
fi

# Parse commands file and format as CSV
csv_data=""
while IFS= read -r line || [[ -n "$line" ]]; do
  # Skip empty lines and single # comments
  [[ -z "$line" || "$line" =~ ^[[:space:]]*#[^#] ]] && continue

  # Split on # for category and description
  if [[ "$line" =~ ^([^#]+)#([^#]+)#(.+)$ ]]; then
    command="${BASH_REMATCH[1]}"
    category="${BASH_REMATCH[2]}"
    description="${BASH_REMATCH[3]}"
  elif [[ "$line" =~ ^([^#]+)##(.+)$ ]]; then
    command="${BASH_REMATCH[1]}"
    category=""
    description="${BASH_REMATCH[2]}"
  elif [[ "$line" =~ ^([^#]+)#(.+)$ ]]; then
    command="${BASH_REMATCH[1]}"
    category=""
    description="${BASH_REMATCH[2]}"
  else
    command="$line"
    category=""
    description=""
  fi

  # Trim whitespace
  command="${command#"${command%%[![:space:]]*}"}"
  command="${command%"${command##*[![:space:]]}"}"
  category="${category#"${category%%[![:space:]]*}"}"
  category="${category%"${category##*[![:space:]]}"}"
  description="${description#"${description%%[![:space:]]*}"}"
  description="${description%"${description##*[![:space:]]}"}"

  # Skip empty commands
  [[ -z "$command" ]] && continue

  # Escape quotes for CSV
  command="${command//\"/\"\"}"
  category="${category//\"/\"\"}"
  description="${description//\"/\"\"}"

  # Add to CSV data
  csv_data+="\"$category\",\"$command\",\"$description\""$'\n'
done <"$COMMANDS_FILE"

# Check if we have any commands
if [[ -z "$csv_data" ]]; then
  echo "No commands found in file" >&2
  echo "Add commands to $COMMANDS_FILE in format: command # description" >&2
  exit 1
fi

# Calculate height and width as 90% of terminal rows and cols
terminal_rows=$(tput lines)
table_height=$((terminal_rows * 90 / 100))

terminal_cols=$(tput cols)
usable_cols=$((terminal_cols * 90 / 100))
cat_cols=$((usable_cols * 10 / 100))
cmd_cols=$((usable_cols * 50 / 100))
desc_cols=$((usable_cols * 40 / 100))

# Display table and get selection
selected=$(echo -n "$csv_data" | gum table \
  --columns "Category,Command,Description" \
  --border rounded \
  --border.foreground "$C_PINK" \
  --header.foreground "$C_MAUVE" \
  --cell.foreground "$C_TEXT" \
  --selected.foreground "$C_BLUE" \
  --selected.background "$C_SURFACE1" \
  --widths "$cat_cols,$cmd_cols,$desc_cols" \
  --height "$table_height") || exit 0

# Exit if nothing selected
[[ -z "$selected" ]] && exit 0

# Extract command (second column, remove quotes)
command=$(echo "$selected" | cut -d',' -f2 | sed 's/^"//; s/"$//')

# Show command being executed
echo -e "\033[2m\$ $command\033[0m"

# Execute the command
eval "$command"
