#!/bin/bash

set -eEo pipefail

# Check if Go is installed
GO_ALREADY_INSTALLED=false
if command -v go &> /dev/null; then
    GO_ALREADY_INSTALLED=true
    echo "Go is already installed"
else
    echo "Go not found, installing..."
    "$WARCHY_PATH/bin/install/install-go.sh"
fi

# Create temporary directory for build
VHDM_BUILD_DIR=$(mktemp -d)
cd "$VHDM_BUILD_DIR" || exit 1

# Clone the repository
gum style --foreground 245 "  → Cloning vhdm repository..."
git clone --quiet "https://github.com/rjdinis-nos/vhdm.git" "$VHDM_BUILD_DIR/vhdm" 2>&1 | grep -v "skipping" || true

cd "$VHDM_BUILD_DIR/vhdm" || exit 1

# Build and install
gum style --foreground 245 "  → Building and installing vhdm..."
sudo make install 2>&1

# Set up bash completion
mkdir -p /etc/bash_completion.d
vhdm completion bash | sudo tee /etc/bash_completion.d/vhdm >/dev/null

# Clean up
cd "$WARCHY_PATH" || exit 1
rm -rf "$VHDM_BUILD_DIR"

# Remove Go if we installed it
if [ "$GO_ALREADY_INSTALLED" = false ]; then
    gum style --foreground 245 "  → Removing Go..."
    source "$WARCHY_PATH/bin/install/remove-go.sh" 2>&1
fi
