#!/usr/bin/env bash

set -euo pipefail

# Note: Ensure warchy-install-pacman-pkgs exists at this path
$HOME/.local/bin/warchy-install-pacman-pkgs pnpm

mkdir -p "$XDG_STATE_HOME/npm/"

# Set environment variables for the current session
export NPM_CONFIG_PREFIX="${XDG_DATA_HOME:-$HOME/.local/share}/npm/modules"
export NPM_CONFIG_USERCONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/npm"
export NPM_CONFIG_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/npm"
export NODE_REPL_HISTORY="${XDG_STATE_HOME:-$HOME/.local/state}/npm/node_repl_history"

# Add npm binaries to path if directory exists and not already present
NPM_BIN="${XDG_DATA_HOME}/npm/modules/bin"
if [ -d "$NPM_BIN" ] && [[ ":$PATH:" != *":$NPM_BIN:"* ]]; then
  export PATH="$NPM_BIN:$PATH"
fi

$HOME/.local/bin/warchy-list-env-vars NPM_CONFIG_PREFIX NPM_CONFIG_USERCONFIG NPM_CONFIG_CACHE NODE_REPL_HISTORY

# Persist configuration to envs file
ENVS_FILE="${XDG_CONFIG_HOME}/bash/envs"

if [ -f "$ENVS_FILE" ]; then
  START_MARKER="# Npm config"
  # Use single quotes for the marker to avoid shell expansion during grep
  END_MARKER='if [ -d "${XDG_DATA_HOME}/npm/modules/bin" ] && [[ ":$PATH:" != *":${XDG_DATA_HOME}/npm/modules/bin:"* ]]; then PATH="${XDG_DATA_HOME}/npm/modules/bin:$PATH"; fi'

  # Safely check and remove the block
  if grep -qF "$START_MARKER" "$ENVS_FILE" && grep -qF "$END_MARKER" "$ENVS_FILE"; then
    # FIX: Using @ as the delimiter to handle / characters in the variable
    # We also prefix the first delimiter with \ for address ranges
    sed -i "\@$START_MARKER@,\@$END_MARKER@d" "$ENVS_FILE"
  fi

  # Append the fresh block
  cat >>"$ENVS_FILE" <<'EOF'
# Npm config
export NPM_CONFIG_PREFIX="${XDG_DATA_HOME:-$HOME/.local/share}/npm/modules"
export NPM_CONFIG_USERCONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/npm"
export NPM_CONFIG_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/npm"
export NODE_REPL_HISTORY="${XDG_STATE_HOME:-$HOME/.local/state}/npm/node_repl_history"
if [ -d "${XDG_DATA_HOME}/npm/modules/bin" ] && [[ ":$PATH:" != *":${XDG_DATA_HOME}/npm/modules/bin:"* ]]; then PATH="${XDG_DATA_HOME}/npm/modules/bin:$PATH"; fi
EOF

  gum style --foreground 245 "  â†’ Npm environment variables updated in $ENVS_FILE"
fi
