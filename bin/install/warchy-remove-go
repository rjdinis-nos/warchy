#!/usr/bin/env bash
set -euo pipefail

source warchy-install-helpers.sh

PACKAGE=go
ENVS_FILE="$XDG_CONFIG_HOME/bash/envs"
START_MARKER="# Golang config"
END_MARKER='export PATH="$GOBIN:$PATH"'

# Check if being sourced or executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  gum style --foreground 196 "Error: This script must be sourced, not executed."
  gum style --foreground 220 "Usage: source $0"
  gum style --foreground 220 "   or:      . $0"
  return 1 2>/dev/null || exit 1
fi

# Uninstall package
warchy-remove-pacman-pkgs $PACKAGE

# Remove package environment variables
if [ -f "$ENVS_FILE" ]; then
  remove_marked_block "$ENVS_FILE" "$START_MARKER" "$END_MARKER"

  gum style --foreground 245 "â†’ $PACKAGE environment variables removed from $ENVS_FILE"
fi

# Remove environment variables from current bash session
unset GOPATH GOBIN GOCACHE
if [[ -n "${GOBIN-}" ]]; then
  PATH="${PATH//:$GOBIN/}"
  PATH="${PATH//$GOBIN:/}"
  PATH="${PATH//$GOBIN/}"
  export PATH
fi

warchy-list-env-vars GOPATH GOBIN GOCACHE
if [[ ":$PATH:" == *":${GOBIN-}:"* ]]; then
  echo "$(gum style --foreground 212 "   PATH")$(gum style --foreground 245 ": $GOBIN")"
fi
