#!/usr/bin/env bash

set -euo pipefail

source warchy-install-helpers.sh

PACKAGE=go
ENVS_FILE="${XDG_CONFIG_HOME}/bash/envs"

# Check if being sourced or executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  gum style --foreground 196 "Error: This script must be sourced, not executed."
  gum style --foreground 220 "Usage: source $0"
  gum style --foreground 220 "   or:      . $0"
  return 1 2>/dev/null || exit 1
fi

# Install package from AUR
warchy-install-pacman-pkgs $PACKAGE

# Package environemnt configuration
ENV_CONFIG=$(
  cat <<'EOF'
# Golang config
export GOPATH="${XDG_DATA_HOME:-$HOME/.local/share}/go"
export GOBIN="$GOPATH/bin"
export GOCACHE="${XDG_CACHE_HOME:-$HOME/.cache}/go-build"
export PATH="$GOBIN:$PATH"
EOF
)

# Export environment variables to current session
eval "$ENV_CONFIG"
warchy-list-env-vars GOPATH GOBIN GOCACHE
if [[ ":$PATH:" == *":$GOBIN:"* ]]; then
  echo "$(gum style --foreground 212 "   PATH")$(gum style --foreground 245 ": $GOBIN")"
fi

if [ -f "$ENVS_FILE" ]; then
  # Append environment configuration to envs file
  append_env_block "$ENVS_FILE" "$ENV_CONFIG"

  # Append newline if the last line is not empty
  [ -s "$ENVS_FILE" ] && [ "$(tail -c1 "$ENVS_FILE")" != "" ] && echo >>"$ENVS_FILE"

  gum style --foreground 245 "â†’ Opencode environment variables updated in $ENVS_FILE"
fi
