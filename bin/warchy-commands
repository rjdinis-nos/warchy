#!/usr/bin/env bash
set -euo pipefail

# Configuration
COMMANDS_FILE="$HOME/.config/warchy/commands"

# Catppuccin Mocha Colors
C_PINK="#f5c2e7"
C_MAUVE="#cba6f7"
C_TEXT="#cdd6f4"
C_SURFACE1="#45475a"
C_BLUE="#89b4fa"
C_YELLOW="#f9e2af"

# Check if commands file exists
if [[ ! -f "$COMMANDS_FILE" ]]; then
    echo "Error: Commands file not found at $COMMANDS_FILE" >&2
    echo "Create it with: mkdir -p $(dirname "$COMMANDS_FILE") && touch $COMMANDS_FILE" >&2
    exit 1
fi

# Parse commands file and format as CSV
csv_data=""
while IFS= read -r line || [[ -n "$line" ]]; do
    # Skip empty lines and single # comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*#[^#] ]] && continue
    
    # Check for section header (## Section Name)
    if [[ "$line" =~ ^[[:space:]]*##[[:space:]]*(.+)$ ]]; then
        section_name="${BASH_REMATCH[1]}"
        section_name="${section_name#"${section_name%%[![:space:]]*}"}"
        section_name="${section_name%"${section_name##*[![:space:]]}"}"
        # Add section separator row - horizontal line in command, section name in description
        section_upper="${section_name^^}"
        csv_data+="\"───────────────────────────────────────────────────────────────────\",\"▸ $section_upper\""$'\n'
        continue
    fi
    
    # Split on first # for description
    if [[ "$line" =~ ^([^#]+)#(.+)$ ]]; then
        command="${BASH_REMATCH[1]}"
        description="${BASH_REMATCH[2]}"
    else
        command="$line"
        description=""
    fi
    
    # Trim whitespace
    command="${command#"${command%%[![:space:]]*}"}"
    command="${command%"${command##*[![:space:]]}"}"
    description="${description#"${description%%[![:space:]]*}"}"
    description="${description%"${description##*[![:space:]]}"}"
    
    # Skip empty commands
    [[ -z "$command" ]] && continue
    
    # Escape quotes for CSV
    command="${command//\"/\"\"}"
    description="${description//\"/\"\"}"
    
    # Add to CSV data
    csv_data+="\"$command\",\"$description\""$'\n'
done < "$COMMANDS_FILE"

# Check if we have any commands
if [[ -z "$csv_data" ]]; then
    echo "No commands found in file" >&2
    echo "Add commands to $COMMANDS_FILE in format: command # description" >&2
    exit 1
fi

# Calculate height as 90% of terminal rows
terminal_rows=$(tput lines)
table_height=$((terminal_rows * 90 / 100))

# Display table and get selection
selected=$(echo -n "$csv_data" | gum table \
    --columns "Command,Description" \
    --border rounded \
    --border.foreground "$C_PINK" \
    --header.foreground "$C_MAUVE" \
    --cell.foreground "$C_TEXT" \
    --selected.foreground "$C_BLUE" \
    --selected.background "$C_SURFACE1" \
    --widths "80,70" \
    --height "$table_height") || exit 0

# Exit if nothing selected
[[ -z "$selected" ]] && exit 0

# Extract command (first column, remove quotes)
command=$(echo "$selected" | cut -d',' -f1 | sed 's/^"//; s/"$//')

# Skip execution if it's a section separator
[[ "$command" =~ ^───+ ]] && exit 0

# Show command being executed
echo -e "\033[2m\$ $command\033[0m"

# Execute the command
eval "$command"
