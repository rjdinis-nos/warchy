#!/usr/bin/env bash
set -euo pipefail

# Configuration
KEYBINDINGS_FILE="$XDG_CONFIG_HOME/bash/keybindings"

# Catppuccin Mocha Colors
C_PINK="#f5c2e7"
C_MAUVE="#cba6f7"
C_TEXT="#cdd6f4"
C_SURFACE1="#45475a"
C_BLUE="#89b4fa"
C_YELLOW="#f9e2af"

# Check if keybindings file exists
if [[ ! -f "$KEYBINDINGS_FILE" ]]; then
  echo "Error: Keybindings file not found at $KEYBINDINGS_FILE" >&2
  echo "Create it with: mkdir -p $(dirname "$KEYBINDINGS_FILE") && touch $KEYBINDINGS_FILE" >&2
  exit 1
fi

# Function to standardize shortcut notation
standardize_shortcut() {
  local key="$1"
  key="${key//\\C-@/Ctrl+Space}"
  key="${key//\\C-/Ctrl+}"
  key="${key//\\e/Alt+}"
  echo "$key"
}

# Parse keybindings file and format as CSV
csv_data=""
while IFS= read -r line || [[ -n "$line" ]]; do
  # Skip lines that don't contain 'bind -x'
  [[ ! "$line" =~ bind[[:space:]]+-x ]] && continue

  # Parse: bind -x '"KEY": COMMAND' # DESCRIPTION
  if [[ "$line" =~ bind[[:space:]]+-x[[:space:]]+\'\"[[:space:]]*([^\"]+)\"[[:space:]]*:[[:space:]]*([^\']+)\'[[:space:]]*#[[:space:]]*(.+)$ ]]; then
    key="${BASH_REMATCH[1]}"
    command="${BASH_REMATCH[2]}"
    description="${BASH_REMATCH[3]}"

    # Standardize the key format
    key=$(standardize_shortcut "$key")

    # Trim whitespace
    command="${command#"${command%%[![:space:]]*}"}"
    command="${command%"${command##*[![:space:]]}"}"
    description="${description#"${description%%[![:space:]]*}"}"
    description="${description%"${description##*[![:space:]]}"}"

    # Escape quotes for CSV
    key="${key//\"/\"\"}"
    command="${command//\"/\"\"}"
    description="${description//\"/\"\"}"

    # Add to CSV data
    csv_data+="\"$key\",\"$command\",\"$description\""$'\n'
  fi
done <"$KEYBINDINGS_FILE"

# Check if we have any keybindings
if [[ -z "$csv_data" ]]; then
  echo "No keybindings found in file" >&2
  echo "Add keybindings to $KEYBINDINGS_FILE" >&2
  exit 1
fi

# Calculate height as 90% of terminal rows
terminal_rows=$(tput lines)
table_height=$((terminal_rows * 60 / 100))

# Display hint first
echo
gum style --foreground 245 --italic "Edit bindings: $KEYBINDINGS_FILE"
echo

# Display table (view only, no selection needed)
echo -n "$csv_data" | gum table \
  --columns "Shortcut,Command,Description" \
  --border rounded \
  --border.foreground "$C_PINK" \
  --header.foreground "$C_MAUVE" \
  --cell.foreground "$C_TEXT" \
  --selected.foreground "$C_BLUE" \
  --selected.background "$C_SURFACE1" \
  --widths "15,70,35" \
  --height "$table_height" >/dev/null || exit 0
