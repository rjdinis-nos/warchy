#!/usr/bin/env python3
import re
import subprocess
import sys
from pathlib import Path

# Configuration
KEYBINDINGS_FILE = Path.home() / ".config/bash/keybindings"

# Catppuccin Mocha Colors
C_PINK = "#f5c2e7"
C_MAUVE = "#cba6f7"
C_TEXT = "#cdd6f4"
C_SURFACE1 = "#45475a"
C_BLUE = "#89b4fa"


def standardize_shortcut(key: str) -> str:
    """Convert key notation to readable format."""
    key = key.replace(r"\C-@", "Ctrl+Space")
    key = key.replace(r"\C-", "Ctrl+")
    key = key.replace(r"\e", "Alt+")
    return key


def parse_keybinding(line: str) -> tuple[str, str, str] | None:
    """
    Parse a keybinding line and return (shortcut, command, description).
    
    Expected format: bind -x '"KEY": COMMAND' # DESCRIPTION
    """
    # Pattern to match: bind -x '"KEY": COMMAND' # DESCRIPTION
    pattern = r'''bind\s+-x\s+'"\s*([^"]+)"\s*:\s*([^']+)'\s*#\s*(.+)'''
    
    match = re.search(pattern, line)
    if not match:
        return None
    
    key, command, description = match.groups()
    
    # Standardize the key format
    key = standardize_shortcut(key)
    
    # Trim whitespace
    command = command.strip()
    description = description.strip()
    
    return key, command, description


def format_as_csv(data: list[tuple[str, str, str]]) -> str:
    """Format parsed data as CSV with proper escaping."""
    lines = []
    for shortcut, command, description in data:
        # Escape double quotes by doubling them (CSV standard)
        shortcut = shortcut.replace('"', '""')
        command = command.replace('"', '""')
        description = description.replace('"', '""')
        
        # Create CSV line with quoted fields
        lines.append(f'"{shortcut}","{command}","{description}"')
    
    return '\n'.join(lines)


def main():
    # Check if keybindings file exists
    if not KEYBINDINGS_FILE.exists():
        print(f"Error: Keybindings file not found at {KEYBINDINGS_FILE}", file=sys.stderr)
        sys.exit(1)
    
    # Read and parse keybindings
    keybindings = []
    try:
        with open(KEYBINDINGS_FILE, 'r') as f:
            for line in f:
                line = line.strip()
                if 'bind -x' in line:
                    result = parse_keybinding(line)
                    if result:
                        keybindings.append(result)
    except Exception as e:
        print(f"Error reading keybindings file: {e}", file=sys.stderr)
        sys.exit(1)
    
    if not keybindings:
        print("No keybindings found in file", file=sys.stderr)
        sys.exit(1)
    
    # Format as CSV
    csv_data = format_as_csv(keybindings)
    
    # Pass to gum table, suppress selection output
    try:
        process = subprocess.Popen(
            [
                'gum', 'table',
                '--columns', 'Shortcut,Command,Description',
                '--border', 'rounded',
                '--border.foreground', C_PINK,
                '--header.foreground', C_MAUVE,
                '--cell.foreground', C_TEXT,
                '--selected.foreground', C_BLUE,
                '--selected.background', C_SURFACE1,
                '--widths', '15,70,35'
            ],
            stdin=subprocess.PIPE,
            stdout=subprocess.DEVNULL,
            text=True
        )
        process.communicate(input=csv_data)
        sys.exit(process.returncode)
    except FileNotFoundError:
        print("Error: 'gum' command not found. Please install gum.", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
