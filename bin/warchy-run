#!/usr/bin/env bash

YELLOW="\x1b[33m"
BOLD="\x1b[1m"
RESET="\x1b[0m"

SEARCH_DIR="${1:-$PWD}"
SEARCH_DIR="${SEARCH_DIR/#\~/$HOME}"
ABS_SEARCH_DIR=$(cd "$SEARCH_DIR" 2>/dev/null && pwd)

if [ -z "$ABS_SEARCH_DIR" ]; then
    echo "Error: Directory '$SEARCH_DIR' does not exist."
    exit 1
fi

# 3. Run fd and fzf with ANSI colors
# Note: Double quotes around the sed command allow $YELLOW and $RESET to work
selected=$(cd "$ABS_SEARCH_DIR" && fd -t f -L | \
    sed "s|^\(.*\)/\(.*\)$|${YELLOW}\1/${RESET}${BOLD}\2${RESET}|" | \
    fzf --ansi \
        --prompt "üöÄ Launch [$(basename "$ABS_SEARCH_DIR")] > " \
        --header "ENTER: run | ESC: cancel" \
        --color="header:italic:cyan,prompt:blue,pointer:red" \
        --border=sharp)

# 4. Strict Execution Check
if [ -n "$selected" ]; then
    # STRIP ANSI COLORS: This is required so the file path is valid for the OS
    CLEAN_SELECTED=$(echo "$selected" | sed 's/\x1b\[[0-9;]*m//g')
    FULL_PATH="$ABS_SEARCH_DIR/$CLEAN_SELECTED"

    if [ -x "$FULL_PATH" ]; then
        "$FULL_PATH"
    else
        echo "‚ùå Error: '$CLEAN_SELECTED' is not executable."
    fi
fi
