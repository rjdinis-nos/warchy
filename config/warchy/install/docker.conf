[package]
PACKAGE_NAME=docker docker-compose docker-buildx lazydocker jq
PACKAGE_INSTALLER=pacman

[post-install]
# Enable IP forwarding if not set
ip_forward_value="$(cat /proc/sys/net/ipv4/ip_forward 2>/dev/null || echo "")"
if [[ -z "$ip_forward_value" || "$ip_forward_value" -eq 0 ]]; then
    gum style --foreground 245 "  → Enabling IP forwarding..."
    echo 'net.ipv4.ip_forward=1' | sudo tee /etc/sysctl.d/20-docker.conf > /dev/null
    sudo sysctl --system > /dev/null 2>&1
else
    gum style --foreground 245 "  → IP forwarding already enabled"
fi

# Configure /etc/docker/daemon.json
gum style --foreground 245 "  → Configuring Docker daemon..."
sudo mkdir -p /etc/docker

# Define the log rotation settings
LOG_CONFIG='{"log-driver":"json-file","log-opts":{"max-size":"10m","max-file":"5"}}'

if [[ -f /etc/docker/daemon.json ]]; then
    # Merge new settings into existing file
    tmpfile=$(mktemp)
    sudo jq --argjson logs "$LOG_CONFIG" \
        '.features.buildkit = true | . += $logs' \
        /etc/docker/daemon.json > "$tmpfile"
    sudo mv "$tmpfile" /etc/docker/daemon.json
else
    # Create from scratch with both BuildKit and Log Rotation
    echo "$LOG_CONFIG" | sudo jq '.features.buildkit = true' | sudo tee /etc/docker/daemon.json > /dev/null
fi

[post-remove]
sudo rm -f /etc/docker/daemon.json
sudo rm -f /etc/sysctl.d/20-docker.conf

# Remove Docker data directories (optional - uncomment if desired)
# sudo rm -rf /var/lib/docker
# sudo rm -rf /var/lib/containerd
